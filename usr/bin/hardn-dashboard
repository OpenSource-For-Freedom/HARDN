#!/bin/bash

# HARDN-XDR Dashboard Launcher
# Launches the GTK dashboard interface for HARDN-XDR

set -euo pipefail

# Constants
readonly HARDN_GUI_DIR="${HARDN_DATA_DIR:-/usr/share/hardn}/gui"
readonly DASHBOARD_SCRIPT="${HARDN_GUI_DIR}/hardn-dashboard.py"

# Check if dashboard script exists
if [[ ! -f "${DASHBOARD_SCRIPT}" ]]; then
    echo "Error: Dashboard script not found at ${DASHBOARD_SCRIPT}"
    echo "Please ensure HARDN-XDR is properly installed."
    exit 1
fi

# Check for required Python packages
check_python_deps() {
    local deps=("gi" "matplotlib" "psutil" "requests")
    local missing=()
    
    for dep in "${deps[@]}"; do
        if ! python3 -c "import ${dep}" 2>/dev/null; then
            missing+=("python3-${dep}")
        fi
    done
    
    if [[ ${#missing[@]} -gt 0 ]]; then
        echo "Error: Missing required Python packages:"
        printf " - %s\n" "${missing[@]}"
        echo ""
        echo "Install them with:"
        echo "  sudo apt install ${missing[*]}"
        exit 1
    fi
}

# Check for X11 display
check_display() {
    if [[ -z "${DISPLAY:-}" ]]; then
        echo "Error: No X11 display available."
        echo "Make sure you're running in a graphical environment."
        exit 1
    fi
}

# Main function
main() {
    echo "Starting HARDN-XDR Dashboard..."
    
    # Check dependencies
    check_python_deps
    check_display
    
    # Launch the dashboard
    exec python3 "${DASHBOARD_SCRIPT}" "$@"
}

# Handle command line arguments
case "${1:-}" in
    --help|-h)
        cat << EOF
HARDN-XDR Dashboard Launcher

USAGE:
    hardn-dashboard [OPTIONS]

OPTIONS:
    -h, --help    Show this help message

DESCRIPTION:
    Launches the GTK-based graphical dashboard for HARDN-XDR security
    monitoring and management. The dashboard provides:
    
    - Real-time system status monitoring
    - Security services management
    - Live system metrics graphs
    - Security logs viewing
    - Kernel parameter monitoring
    
    Some features require root privileges. Run with sudo for full functionality.

EXAMPLES:
    hardn-dashboard              # Launch dashboard
    sudo hardn-dashboard         # Launch with full privileges

EOF
        exit 0
        ;;
    --version)
        echo "HARDN-XDR Dashboard v${HARDN_VERSION:-2.0.0}"
        exit 0
        ;;
    *)
        main "$@"
        ;;
esac